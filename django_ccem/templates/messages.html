{% extends 'ccem_sim/base.html' %}
{% load url_extras %}

{% block script_onload %}
	$('#filterClear').click(function(){
		$('#filterForm').find('input[type="text"]').val('');
	});
	$('.panel-heading.chevron').click(function(){
		$(this).find('span').toggleClass('glyphicon-chevron-down').toggleClass('glyphicon-chevron-up');
	});
{% endblock %}

{% block left_panel %}
	<ul class="nav nav-pills nav-stacked">
		<li {% if request.GET.type == None %} class="active" {% endif %}><a href="/moderation/messages">All</a></li>
		<li {% if request.GET.type == 'regular' %} class="active" {% endif %}><a href="/moderation/messages?type=regular">Regular</a></li>
		<li {% if request.GET.type == 'submission' %} class="active" {% endif %}><a href="/moderation/messages?type=submission">Submission</a></li>
		<li {% if request.GET.type == 'flagged' %} class='active' {% endif %}><a href="/moderation/messages?type=flagged">Flagged</a></li>
	</ul>
{% endblock %}

{% block content %}

{% include 'form_filter.html' %}

{% if messages %}

<table class="table table-hover table-bordered">
<tr class='info'>
	<th style="width:200px"><span class="glyphicon chevron-down"></span>Date</th>
	<th style="width:500px">Message</th>
	<th style="width:150px">Contact</th>
	<th>Health Unit</th>
</tr>
{% for m in messages %}
<tr>
	<td>{{ m.created }}</td>
	<td data-toggle='collapse' data-target='#msg_info_{{ m.id }}'>
		<span class="alert alert-{% if not m.has_error %}info{% else %}danger{% endif %}">{{ m.message.text }}</span>
		<span class="glyphicon glyphicon-{% if m.is_submission %}ok-sign{% else %}question-sign{% endif %}"></span>
	</td>
	<td><a href="?{% url_replace request 'contact' m.message.connection.identity %}">{{ m.message.connection.identity }}</a></td>
	<td>{{m.message.connection.dhis2_contact.contact.facility}}</td>
</tr>
<tr id='msg_info_{{ m.id }}' class='collapse'>
	<td></td>
	<td colspan=3>
		<ul>
		    {% for r in m.report_set.all %}
		    	<li>{{ r.response.text }}</li>
		    {% empty %}
		    	<li>No Report</li>
		    {% endfor %}
		</ul
	</td>
</tr>
{% endfor %}
</table>

<div class='pager'>

{% if messages.has_previous %}
	<li><a href="?{% url_replace request 'page' messages.previous_page_number %}">Previous</a></li>
{% else  %}
	<li class='disabled'><a href='#'>Previous</a><li>
{% endif %}

{% if messages.paginator.num_pages > 1 %}
Page <form action='#', method='get'>
	<input type='text' name='page' value='{{messages.number}}'/>
	<input type='submit' value='Go'/>
	</form> of {{messages.paginator.num_pages }}
{% else %}
	Page 1 of 1
{% endif %}
({{ messages.paginator.count }} Messages)

{% if messages.has_next %}
	<li><a href="?{% url_replace request 'page' messages.next_page_number %}">Next</a></li>
{% else  %}
	<li class='disabled'><a href='#'>Next</a></li>
{% endif %}

{% else %}

<div class='panel panel-warning'>
	<div class='panel-heading'>
		<h3 class='panel-title'>Message</h3>
	</div>
	<div class='panel-body'>
		No messages were found for the given query.
	</div>
</div>

{% endif %}

{% endblock %}
